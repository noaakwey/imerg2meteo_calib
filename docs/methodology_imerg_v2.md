# Методика IMERG V2: калибровка с контролем объема на 3ч/сутки/год

## 1. Цель и контекст
Цель V2: убрать системное завышение годовых сумм осадков после калибровки IMERG и сохранить форму внутрисобытийной интенсивности для расчета `R` и `I30`.

Критичный симптом до исправлений: в калиброванных годовых растрах для части станций (включая Казань) получались суммы, сильно выше наблюдений.

## 2. Подтвержденные причины ошибки

### 2.1. Темпоральный mismatch обучающей и рабочей сетки
В срочных станционных данных отсутствуют «сухие» сроки, поэтому фактически наблюдались неполные наборы часов.
Если QM обучать на неполной 3-часовой сетке, а применять к полному 30-минутному потоку, появляется скрытый множитель объема.

Факт по Казани:
- IMERG annual mean на полной 3ч-сетке: `534.0 мм/год`
- IMERG annual mean на legacy-сетке сроков: `328.3 мм/год`
- mismatch фактор: `1.63x`

### 2.2. Пространственная ошибка привязки станции к пикселю
В station CSV оси были перепутаны (`X`/`Y`), что ломало nearest-station назначение.
После фикса (`X=lat`, `Y=lon`) диагностика KNN показала:
- уникальные ближайшие станции на AOI: `1 -> 8`
- медианная дистанция пиксель-станция: `187.73 -> 64.48 км`

### 2.3. Отсутствие верхнеуровневого контроля годового объема
Сезонный 3ч-QM без ограничителей в правом хвосте способен накапливать нефизичный годовой объем.

## 3. Алгоритм V2

### Шаг A. Подготовка пар для обучения
- Используется полная 3-часовая сетка: `00,03,06,09,12,15,18,21`.
- Пропущенные в station CSV сроки восстанавливаются как `0 мм`.
- Это выравнивает геометрию обучения и применения.

### Шаг B. Базовая калибровка на 3ч
- Сезонный Full-Distribution QM (`DJF/MAM/JJA/SON`) по 3ч суммам.
- Применение по зонам ближайшей станции (KNN/Voronoi).
- Обратная пропорциональная дезагрегация в 30-минутные слоты.

### Шаг C. Суточный constraint
- После 3ч-QM суточная сумма корректируется к целевой суточной сумме (daily QM).
- Масштабирование выполняется внутри суток.

### Шаг D. Годовой sanity guard
- По train-периоду строится распределение годовых отношений `station/raw`.
- Годовой объем после калибровки ограничивается обученным envelope.
- Назначение: исключить «тропический» объем в умеренных условиях.

## 4. Метрики и бюджет ошибок

### 4.1. Метрики
- `PBIAS = 100 * sum(sim - obs) / sum(obs)`
- `KGE = 1 - sqrt((r-1)^2 + (alpha-1)^2 + (beta-1)^2)`

Контрольные масштабы:
- 3ч (событийная структура),
- сутки (водный баланс),
- год (климатический объем и sanity).

### 4.2. Остаточные неопределенности
- Точка vs пиксель: физически не устранима полностью.
- Разреженность сети станций в ряде зон AOI.
- Нестационарность переноса (обучение 2001-2015, применение на поздние годы).
- Хвостовые экстремумы (редкие события).

## 5. Результаты пост-пересчета (контроль Казань)
Сравнение по полным годам (`completeness >= 0.99`): `2001-2024`, `N=24`.

- `PBIAS old raster`: mean/median = `+79.15% / +73.12%`
- `PBIAS new raster (v2)`: mean/median = `-8.43% / -7.44%`
- `PBIAS new raster` диапазон: `-32.15% .. +7.02%`

Отдельно: `2025` неполный по станции (`2184 / 2920`, completeness `0.748`), поэтому год не используется в итоговом annual score.

## 6. Проверка физической правдоподобности по AOI
По `output/imerg_rfactor_calib_v2`:
- отрицательных значений и NaN не обнаружено,
- диапазон `p99` годовых сумм по AOI: `462.7 .. 842.1 мм/год`,
- диапазон `max` годовых сумм по AOI: `519.3 .. 906.4 мм/год`.

## 7. Воспроизводимость

### 7.1. Пересчет
```bash
python src/main.py --dataset imerg
python src/apply_qm_to_rasters.py --dataset imerg --calib output/calib_imerg --out output/imerg_rfactor_calib_v2
```

### 7.2. Доказательная база
```bash
python src/build_imerg_evidence_pack.py
```

Артефакты:
- `docs/evidence_imerg_qc.md`
- `docs/graphics/evidence_*.png`
- `docs/kazan_annual_balance_v2.csv`
- `docs/kazan_old_vs_new_full_years.csv`
- `docs/aoi_annual_quantiles_v2.csv`

## 8. Критерии приемки (рекомендуемые)
- Annual median `|PBIAS|` по контрольным станциям: стремиться к `<= 10%`.
- Отсутствие устойчивого положительного annual bias (`> +20%`) на контроле.
- Отсутствие нефизичного роста годовых сумм по AOI.
- Обязательная фиксация неполных лет (как `2025`) отдельно от итоговой annual оценки.
