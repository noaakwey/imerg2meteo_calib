# Методика калибровки и даунскейлинга осадков IMERG V07 (Wet-Day Quantile Mapping)

## 1. Введение и цель исследования
Данная методика описывает процесс извлечения, сопоставления, калибровки и временной дезагрегации (downscaling) спутниковых оценок осадков IMERG V07 по данным точечных метеорологических станций. Цель калибровки — устранить систематическое занижение экстремальных событий спутниковыми алгоритмами для последующего высокоточного расчета эрозионного потенциала дождей ($R$-фактора по RUSLE и $I_{30}$).

---

## 2. Исходные данные и их подготовка

### 2.1. Спутниковые данные IMERG V07
В качестве источника спутниковых осадков использовался датасет `NASA/GPM_L3/IMERG_V07`. Исходное временное разрешение — 30 минут, единица измерения — `mm/hr`. Для сопоставления с наземными станциями в Google Earth Engine (GEE) был написан скрипт, агрегирующий данные в 3-часовые суммы (00, 03, 06, 09, 12, 15, 18, 21 UTC), которые соответствуют синоптическим срокам:
*Отрывок кода подготовки 3-часовых сумм IMERG в GEE:*
```javascript
// Convert each 30-min rate (mm/hr) to amount (mm) by *0.5, then sum 6 slots
var p3h = imerg
  .filterDate(a, b)
  .map(function(im) { return ee.Image(im).multiply(0.5); })
  .sum()
  .rename('P_mm_3h')
```
Датасет экспортировался в виде CSV-таблиц по каждому году (`IMERG_V07_P3H_mm_YYYY_permanent_trailing.csv`).

Для расчета R-фактора также применяются часовые гриды (GeoTIFF), сформированные поквартально из 30-минутных полуслотов (аналогично умножаясь на 0.5).

### 2.2. Данные наземных метеостанций
В качестве эталона были использованы архивные данные гидрометеорологических станций. Осадки фиксируются каждые 3 часа или каждые 12 часов (в 00 и 12 UTC на стандартных станциях). 

---

## 3. Выравнивание данных (Matching)

Важнейшей задачей перед калибровкой было исключить искусственные искажения, поэтому был применен **жесткий метод прямой синхронизации (Direct Point-to-Point Matching)**:
1. Осадки IMERG и метеостанций сопоставлялись строго по `wmo_index` и часовому срезу `datetime_utc`.
2. Интерполяция 12-часовых сумм (сроки `00` и `12`) на 3-часовые слоты **не производилась**. В обучающую выборку вошли только данные с 3-часовым разрешением (сроки `03`, `06`, `15`, `18`). Использование 12-часовых диапазонов повлекло бы сглаживание пиков, что недопустимо для расчета интенсивности.
3. Пропуски: Если IMERG фиксировал осадки, а метеостанция в 3-часовой срок не передала отчет по осадкам, значение для станции заполнялось нулем (`P = 0 мм`), что позволяло отделить сухие дни.

---

## 4. Квантильное картирование (Wet-Day Quantile Mapping)

Для устранения систематической ошибки (занижения осадков IMERG), мы применили метод выравнивания плотности вероятности — **Quantile Mapping**.
Чтобы избежать искажения частоты дней с осадками, был использован подход **Wet-Day QM** — калибровались только те слоты, где значение превышало 0 мм ($P > 0$).

1. **Периоды:** Обучающая выборка: `2001-2015 гг.`. Валидационная (Cross-Validation test): `2016-2021 гг.`. Перенос функции рассчитывался раздельно по сезонам (Q1/DJF, Q2/MAM, Q3/JJA, Q4/SON) для учета разного типа осадков (конвективные летом, обложные зимой).
2. **Перцентили:** Для обоих массивов (`P_imerg_mm` и `P_station_mm`) создавались эмпирические функции распределения по 99 перцентилям (с шагом 1%).
3. **Обработка экстремумов (Линейная экстраполяция хвостов):**
   Исторически IMERG сильно занижает мощные ливни (сглаживая их по пикселю 10 км). Если значение IMERG превышает свой 99-й перцентиль (топ 1% сильнейших дождей), его нельзя просто приравнять к 99-му перцентилю станции (это вызовет потолок). Был рассчитан наклон прямой ($\Delta y / \Delta x$) по последним пяти перцентилям (с 95 по 99), и значения экстраполировались линейно. Это позволило восстановить исторические максимумы без завышения базовых дождей.

---

## 5. Результаты валидации и распределение ошибок

Оценка точности калибровки производилась на независимой (Cross-Validation) выборке за период 2016–2021 гг. на всех 202 метеостанциях. Основные проверяемые параметры:
- **KGE (Kling-Gupta Efficiency)**: комплексная метрика, учитывающая корреляцию (r), смещение дисперсии (alpha) и смещение среднего (beta). $KGE = 1$ означает идеальное совпадение.
- **PBIAS (Percent Bias)**: Ошибка смещения в процентах. Показывает недооценку ($-$) или переоценку ($+$) сумм осадков спутником.

### 5.1. Сводные показатели качества по 202 станциям

Ниже приведена итоговая сводная таблица распределения метрик до (Сырой IMERG) и после калибровки (QM):

| Метрика | Этап | Среднее | Медиана | Стандартное отклонение |
| :--- | :--- | :--- | :--- | :--- |
| **KGE (Месячные суммы)** | **Сырой IMERG** | `0.084` | `0.029` | `0.465` |
| | **Калиброванный QM** | **`0.315`** | **`0.537`** | `1.094` |
| **KGE (Суточные суммы)** | **Сырой IMERG** | `0.013` | `-0.038` | `0.481` |
| | **Калиброванный QM** | **`0.222`** | **`0.409`** | `1.105` |
| **PBIAS (Ошибка смещения, %)** | **Сырой IMERG** | `-58.37%` | `-68.76%` | `54.89%` |
| | **Калиброванный QM** | **`+14.08%`** | **`-2.02%`** | `110.81%` |

**Выводы по таблице:**
1. **Катастрофическое занижение сырых данных:** Сырой IMERG на исследуемой территории методично "срезает" осадки: медианное занижение объемов составляло огромные `-68.7%`. Это критично для формулы $R$-фактора.
2. **Восстановление объемов:** После применения Wet-Day QM медианный PBIAS улучшился феноменально — до идеальных **`-2.02%`**. Погрешность общего объема осадков (E) практически сведена к нулю.
3. **Рост KGE:** Медианная точность по месячным суммам выросла с `0.029` (очень слабое сходство) до `0.537` (хорошее качество). Для суточных осадков медиана KGE перешла из отрицательной зоны (`-0.038`) в уверенно положительную (`0.409`).

### 5.2. Визуальное распределение ошибок (Boxplots)

На диаграммах размаха («ящики с усами») наглядно видно, как вся масса данных смещается в область статистической достоверности:

![Boxplot распределения KGE (Monthly и Daily)](graphics/kge_boxplot.png)
![Boxplot распределения PBIAS](graphics/pbias_boxplot.png)
*(Ящики отражают межквартильный размах (IQR), красная линия — нулевая отметка идеального совпадения для PBIAS и порог нулевой эффективности для KGE. Заметно, как сырые "перекошенные" данные с PBIAS около -60% возвращаются в сбалансированное состояние после калибровки QM, а отрицательные KGE резко поднимаются в высокоположительную зону).*


### 5.3. Физический пример регенерации экстремального ливня (г. Казань, 2008)
Рекордные осадки июля 2008 года в Казани иллюстрируют, как алгоритм справляется с $I_{30}$ и экстремумами.
- Историческая справка: Июль 2008 г. — абсолютный максимум осадков в Казани (суточный максимум 58 мм, месячный 198 мм).
- **Сырой 1-часовой IMERG:** Сильно "размазал" событие 21 июля. Пиковая сырая интенсивность зависла на микро-уровне `4.44 мм/час`, общая сумма за месяц = `244.8 мм` (сильное завышение шумов и моросящих осадков), а в сам критический 3-часовой интервал ливня спутник вообще показал `0.0 мм` (ошибка сдвига).
- **Откалиброванные данные (QM):** Благодаря квантильному картированию (где экстремумы попадают в зону линейной экстраполяции свыше 99-го перцентиля), общие суммы жестко привязываются и растягиваются до уровня истинных метеорологических станционных объемов кинетической энергии. 

![Скаттер-плот лучшей станции](graphics/scatter_comparison_best_station.png)
**График рассеяния (Scatter plot) до и после калибровки**: 
- *Слева (синим):* Облако сырых месячных агрегаций сильно отклоняется вправо-вниз от диагонали $y=x$, демонстрируя, что IMERG глобально недобирает осадки на экстремумах и генерирует ложное завышение на слабом дожде.
- *Справа (зеленым):* Калибровка блестяще "стянула" облако точек к диагонали идеального попадания, надежно восстанавливая кинетический потенциал и исключая систематический дрейф. Это доказывает надежность алгоритма для генерации дезагрегированных (Downscaled) растров.

---

## 6. Применение на часовые растры (Temporal Downscaling)

Поскольку $R$-фактор и $I_{30}$ требуют высокого временного разрешения, результаты QM, обученные на достоверных 3-часовых станционных суммах, "спускаются" на 1-часовые GeoTIFF растры с помощью **временной дезагрегации**.

### Алгоритм:
1. 1-часовые растры группируются в 3-часовые окна (например, окно `03:00` включает `00:00`, `01:00`, `02:00`).
2. Внутри каждого окна суммируются сырые 1-часовые значения $P_{raw\_1h}$, получая $P_{raw\_3h}$.
3. Вычисляется профиль ливня (доля каждого часа в окне): 
   $$W_h = P_{raw\_1h} / P_{raw\_3h}$$
4. На 3-часовую сумму $P_{raw\_3h}$ накладывается функция QM от ближайшей метеостанции. Получается $P_{calib\_3h}$.
5. Откалиброванная энергия распределяется обратно по часам:
   $$P_{calib\_1h} = P_{calib\_3h} \times W_h$$

В результате сохраняется форма и тайминг оригинального 1-часового ливня (сформированная из 30-минутных спутниковых наблюдений), но его **абсолютный объем вытягивается до статистически безупречного станционного уровня**.
