# Калибровка осадков IMERG V07 и ERA5-Land для расчёта R-фактора RUSLE

## Назначение

Репозиторий содержит инструменты станционной калибровки спутниковых и реанализных данных об осадках для восстановления реалистичного водного баланса, сохранения субсуточной структуры интенсивности ($R$, $I_{30}$) и устойчивого поведения в экстремальные годы.

Основной рабочий режим IMERG — **v5_year_anchor**.

## Исходные данные

| Продукт | Источник | Период | Разрешение |
|---------|----------|--------|------------|
| IMERG V07 | NASA GPM | 2001–2025 | 30 мин, 0.1° |
| ERA5-Land | ECMWF | 1966–2025 | 1 ч, 0.1° |
| Наземные станции | Росгидромет | 202 станции | 3-часовые сроки |

## Быстрый старт

### Установка
```bash
pip install numpy pandas rasterio rioxarray matplotlib
```

### 1. Распаковка данных
```bash
python unpack_data.py
```

### 2. Построение калибровочных таблиц
```bash
python src/main.py --dataset imerg
python src/main.py --dataset era5land
```

### 3. Применение калибровки к растровому архиву
```bash
python src/apply_qm_to_rasters.py \
  --dataset imerg \
  --zip "путь/к/IMERG_RFACTOR_ANNUAL.zip" \
  --calib output/calib_imerg
```

### 4. Генерация доказательной базы
```bash
python src/build_imerg_evidence_pack.py
```

## Структура репозитория

```
imerg2meteo_calib/
├── README.md                    # Этот файл
├── unpack_data.py               # Распаковка исходных архивов
├── data/                        # Исходные данные (не в git)
│   ├── imerg/                   # IMERG 3ч CSV по станциям
│   ├── era5land/                # ERA5-Land 3ч CSV по станциям
│   └── meteo/                   # Срочные наблюдения станций
├── src/                         # Исходный код
│   ├── main.py                  # Построение калибровочных таблиц
│   ├── qm_calibration.py        # Ядро квантильного картирования
│   ├── apply_qm_to_rasters.py   # Применение калибровки к растрам
│   ├── build_imerg_evidence_pack.py  # Генерация отчётов и графиков
│   ├── data_loader.py           # Загрузка и подготовка данных
│   ├── validation.py            # Метрики валидации (KGE, PBIAS)
│   ├── analyze_results.py       # Визуализация метрик по станциям
│   ├── batch_calibrate_rasters.py  # Пакетная обработка растров
│   ├── test_kazan_2008.py       # Тест: верификация по Казани (2008)
│   └── test_loader.py           # Тест: загрузчик данных
├── output/                      # Результаты (не в git)
│   ├── calib_imerg/             # Калибровочные таблицы IMERG
│   ├── calib_era5land/          # Калибровочные таблицы ERA5-Land
│   └── imerg_rfactor_calib_v5_year_anchor/  # Калиброванные растры
└── docs/                        # Документация
    ├── методика.md              # Полная методика с экспериментами
    └── graphics/                # Графики и диаграммы (22 файла)
```

## Методика

Подробное описание алгоритмов, экспериментов, таблиц и графиков — в файле **[docs/методика.md](docs/методика.md)**.

## Итоговые метрики

Кросс-валидация на 202 станциях, 2016–2021 гг. (медианы):

| Продукт | KGE (мес.) | KGE (сут.) | PBIAS |
|---------|:---:|:---:|:---:|
| IMERG — сырой | 0.03 | −0.04 | −68.8% |
| **IMERG — калиброванный (v5)** | **0.68** | **0.49** | **−1.4%** |
| ERA5 — сырой | 0.03 | −0.03 | −66.1% |
| **ERA5 — калиброванный (MW QM)** | **0.72** | **0.58** | **−6.9%** |

## Карта скриптов

| Скрипт | Назначение |
|--------|-----------|
| `src/main.py` | Построение калибровочных таблиц по станциям |
| `src/apply_qm_to_rasters.py` | Применение калибровки к растровым архивам |
| `src/build_imerg_evidence_pack.py` | Генерация таблиц, графиков и доказательного отчёта |
| `src/qm_calibration.py` | Ядро квантильного картирования (Full-Distribution QM) |
| `src/analyze_results.py` | Boxplot/scatter по метрикам станций |
