import docx
from docx.shared import Pt
import os

def create_docx(output_path):
    doc = docx.Document()
    
    style = doc.styles['Normal']
    font = style.font
    font.name = 'Times New Roman'
    font.size = Pt(12)

    doc.add_heading('Техническое задание', 0)
    doc.add_paragraph('Калибровка и временной даунскейлинг спутниковых осадков IMERG V07\nпо данным метеостанций ЕЧР методом Wet-Day Quantile Mapping\nдля расчёта R-фактора RUSLE\n\nКФУ, Институт экологических наук\nВерсия 3.0 · Февраль 2026')
    
    doc.add_heading('1. Введение и цель работы', level=1)
    doc.add_paragraph('Настоящее техническое задание описывает актуализированную методологию, входные данные, алгоритм калибровки, результаты верификации и порядок применения откалиброванных данных для расчёта пространственно распределённого R-фактора RUSLE по территории ЕЧР.')
    doc.add_paragraph('Конечная цель — создание временны́х рядов откалиброванных часовых растровых полей осадков с 2001 по 2025 г. Данные предназначены для долгосрочного углеродного мониторинга.')
    
    doc.add_heading('2. Описание входных данных', level=1)
    doc.add_heading('2.1. Срочные наблюдения метеостанций ЕЧР (эталонные данные)', level=2)
    doc.add_paragraph('Источник: база данных метеорологических срочных наблюдений Росгидромет (КМ-1). Набор данных: 202 файла CSV. Общий объём: 3 242 347 строк.')
    
    doc.add_heading('2.2. IMERG V07 — 3-часовые суммы по метеостанциям', level=2)
    doc.add_paragraph('Источник: NASA GPM IMERG V07 Half-Hourly, продукт permanent, 2001–2021. Данные агрегированы в GEE в виде trailing-sum по синоптическим срокам UTC (00, 03, 06, 09, 12, 15, 18, 21). Алгоритм: два слота mm/hr × 0,5.')
    
    doc.add_heading('2.3. Часовые растровые стеки IMERG', level=2)
    doc.add_paragraph('Для расчёта R-фактора используются квартальные GeoTIFF-стеки P1h_mm.')
    
    doc.add_heading('3. Методология: Wet-Day Quantile Mapping', level=1)
    doc.add_heading('3.1. Принцип метода', level=2)
    doc.add_paragraph('Wet-Day QM калибрует распределение значений P > 0 мм, предотвращая искажение частоты дождливых дней. Метод трансформирует функцию распределения (CDF) значений IMERG к CDF метеостанций, уделяя особое внимание экстремальным хвостам.')
    
    doc.add_heading('3.2. Алгоритм сопоставления данных (Direct Point-to-Point Matching)', level=2)
    doc.add_paragraph('1. Совместить данные по datetime_utc строго до часа.\n2. В обучающую выборку включать только сроки 03, 06, 15, 18 UTC. Сроки 00 и 12 UTC (12-часовые суммы) исключаются для исключения сглаживания.\n3. Пропуски: если IMERG фиксирует осадки, а станция — нет, P_station = 0 мм.')
    
    doc.add_heading('3.3. Построение QM-моделей', level=2)
    doc.add_paragraph('Построить ECDF для IMERG и станции по 99 перцентилям. Обработка хвоста выше 99-го перцентиля выполняется через линейную экстраполяцию по наклону последних 5 перцентилей (95–99).')
    
    doc.add_heading('4. Применение QM к часовым растрам (Spatial KDTree & Temporal Downscaling)', level=1)
    doc.add_paragraph('Методика пространственной интерполяции (Kriging) 396 сеточных коэффициентов заменена на более быстрый и точный метод динамического применения моделей ближайшего соседа (Nearest Neighbor).')
    doc.add_paragraph('Алгоритм:')
    doc.add_paragraph('1. Для каждого пикселя GeoTIFF растра определяется ближайшая метеостанция с помощью пространственного индекса (scipy.spatial.cKDTree).\n2. Внутри 3-часового окна агрегируются сырые часовые значения: P_raw_3h = Σ P_raw_1h.\n3. Рассчитывается профиль (доля каждого часа): W_h = P_raw_1h / P_raw_3h.\n4. Применяется функция QM ближайшей станции к 3-часовой сумме: P_calib_3h = QM(P_raw_3h).\n5. Откалиброванная энергия распределяется обратно: P_calib_1h = P_calib_3h × W_h.')
    
    doc.add_heading('5. Результаты верификации (2016-2021)', level=1)
    doc.add_paragraph('Применение алгоритма устраняет систематическое занижение экстремальных событий спутником (медианный PBIAS до калибровки составлял -68.7%). После калибровки медиана ошибки смещения восстановлена до -2.0%.\nМедиана KGE (Kling-Gupta Efficiency) для месячных сумм улучшилась с 0.03 до 0.54. Для суточных осадков KGE возрос с -0.04 до 0.41.')
    doc.add_paragraph('Оценка на примере рекорда в Казани (июль 2008 г.): алгоритм успешно извлек заниженные спутником интенсивности (0 мм в 3-часовой интервал) и восстановил кинетическую энергию экстремума благодаря линейной экстраполяции QM без потерь суточных объемов.')
    
    doc.add_heading('6. Программная реализация', level=1)
    doc.add_paragraph('Структура проекта:\n- src/main.py: Оркестратор парсинга и калибровки метеостанций.\n- src/data_loader.py: Логика загрузки (без интерполяций).\n- src/qm_calibration.py: Wet-day QM с экстраполяцией.\n- src/validation.py: Расчет PBIAS, KGE.\n- src/batch_calibrate_rasters.py: Пакетный скрипт обработки часовых GeoTIFF растров.\n- src/analyze_results.py: Визуализация ошибок.')
    
    doc.save(output_path)
    print(f"Created {output_path}")

if __name__ == "__main__":
    out = r"C:\Users\artur\Downloads\ТЗ_калибровка_IMERG_V07_v3_Updated.docx"
    create_docx(out)
